{% extends "base.html" %}

{% block title %}Leaderboard - {{ contest.name }}{% endblock %}

{% block content %}
<div class="nav">
    <div>
        <strong>{{ contest.name }}</strong> - Leaderboard
    </div>
    <div>
        <a href="/">Home</a>
        {% if contest.status == "active" %}
            <a href="/contest/{{ contest.id }}/problems">Problems</a>
        {% endif %}
        {% if let Some(user) = username %}
            <span>{{ user }}</span>
        {% endif %}
    </div>
</div>

<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <h2 style="font-size: 1.875rem; margin-bottom: 24px;">Final Standings</h2>

    <div style="background-color: #1e293b; border-radius: 8px; overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; min-width: 800px; table-layout: fixed;">
            <colgroup>
                <col style="width: 60px;">
                <col style="width: 150px;">
                <col style="width: 80px;">
                <col style="width: 100px;">
                {% for pid in problem_ids %}
                    <col style="width: 120px;">
                {% endfor %}
            </colgroup>
            <thead>
                <tr style="background-color: #0f172a;">
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600;">Rank</th>
                    <th style="padding: 12px 8px; text-align: left; font-weight: 600;">Username</th>
                    <th style="padding: 12px 8px; text-align: center; font-weight: 600;">Solved</th>
                    <th style="padding: 12px 8px; text-align: right; font-weight: 600;">Total</th>
                    {% for (idx, pid) in problem_ids.iter().enumerate() %}
                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; font-size: 0.875rem; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <a href="/contest/{{ contest.id }}/problems/{{ pid }}" style="color: inherit; text-decoration: none;" title="{{ problem_titles[idx] }}">
                                {{ problem_titles[idx] }}
                            </a>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for (idx, entry) in entries.iter().enumerate() %}
                <tr style="border-top: 1px solid #334155;">
                    <td style="padding: 12px 8px; color: #94a3b8;">{{ idx + 1 }}</td>
                    <td style="padding: 12px 8px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ entry.username }}
                    </td>
                    <td style="padding: 12px 8px; text-align: center; color: #94a3b8;">
                        {{ entry.problems_solved }}
                    </td>
                    <td style="padding: 12px 8px; text-align: right; color: #fbbf24; font-weight: 600;">
                        {{ entry.total_bytes }}
                    </td>
                    {% for result in entry.problem_results %}
                        <td style="padding: 12px 8px; text-align: center; font-size: 0.875rem; white-space: nowrap;">
                            {% if let Some(r) = result %}
                                {% if r.medal == "diamond" %}
                                    <span style="color: #60a5fa; font-weight: 700;" title="{{ r.code_length }} bytes (unique best!)">ðŸ’Ž {{ r.code_length }}</span>
                                {% else if r.medal == "gold" %}
                                    <span style="color: #fbbf24; font-weight: 700;" title="{{ r.code_length }} bytes (tied best)">ðŸ¥‡ {{ r.code_length }}</span>
                                {% else %}
                                    <span style="color: #94a3b8;" title="{{ r.code_length }} bytes">{{ r.code_length }}</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #374151;">-</span>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div style="margin-top: 24px; padding: 16px; background-color: #1e293b; border-radius: 8px; color: #94a3b8; font-size: 0.875rem;">
        <h3 style="font-size: 1rem; margin-bottom: 8px; color: #e5e7eb;">Scoring Rules</h3>
        <ul style="list-style: disc; padding-left: 20px; line-height: 1.75;">
            <li><strong>Total Score</strong>: Sum of bytes across all solved problems (lower is better)</li>
            <li><strong style="color: #60a5fa;">ðŸ’Ž Diamond</strong>: Unique shortest solution for a problem (only one person has it)</li>
            <li><strong style="color: #fbbf24;">ðŸ¥‡ Gold</strong>: Tied shortest solution (multiple people have the same best)</li>
            <li>Rankings are determined by: (1) Most problems solved, (2) Lowest total bytes</li>
        </ul>
    </div>
</div>

<script>
// Helper to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-refresh every 1 second by fetching JSON data
async function refreshLeaderboard() {
    try {
        const url = window.location.pathname;
        const apiUrl = url.replace('/contest/', '/api/contest/');
        const response = await fetch(apiUrl);
        if (!response.ok) return;

        const data = await response.json();
        const tbody = document.querySelector('tbody');
        const contestId = url.split('/')[2];

        // Build new tbody HTML
        let html = '';
        data.entries.forEach((entry, idx) => {
            html += `<tr style="border-top: 1px solid #334155;">
                <td style="padding: 12px 8px; color: #94a3b8;">${idx + 1}</td>
                <td style="padding: 12px 8px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(entry.username)}
                </td>
                <td style="padding: 12px 8px; text-align: center; color: #94a3b8;">
                    ${entry.problems_solved}
                </td>
                <td style="padding: 12px 8px; text-align: right; color: #fbbf24; font-weight: 600;">
                    ${entry.total_bytes}
                </td>`;

            entry.problem_results.forEach(result => {
                if (result) {
                    if (result.medal === 'diamond') {
                        html += `<td style="padding: 12px 8px; text-align: center; font-size: 0.875rem; white-space: nowrap;">
                            <span style="color: #60a5fa; font-weight: 700;" title="${result.code_length} bytes (unique best!)">ðŸ’Ž ${result.code_length}</span>
                        </td>`;
                    } else if (result.medal === 'gold') {
                        html += `<td style="padding: 12px 8px; text-align: center; font-size: 0.875rem; white-space: nowrap;">
                            <span style="color: #fbbf24; font-weight: 700;" title="${result.code_length} bytes (tied best)">ðŸ¥‡ ${result.code_length}</span>
                        </td>`;
                    } else {
                        html += `<td style="padding: 12px 8px; text-align: center; font-size: 0.875rem; white-space: nowrap;">
                            <span style="color: #94a3b8;" title="${result.code_length} bytes">${result.code_length}</span>
                        </td>`;
                    }
                } else {
                    html += `<td style="padding: 12px 8px; text-align: center; font-size: 0.875rem; white-space: nowrap;">
                        <span style="color: #374151;">-</span>
                    </td>`;
                }
            });

            html += '</tr>';
        });

        tbody.innerHTML = html;
    } catch (err) {
        console.error('Failed to refresh leaderboard:', err);
    }
}

setInterval(refreshLeaderboard, 1000);
</script>
{% endblock %}
